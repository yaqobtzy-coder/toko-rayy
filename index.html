<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const db = getDatabase(initializeApp({ databaseURL: "https://rayy-all-web-default-rtdb.asia-southeast1.firebasedatabase.app/" }));

    // LOGIKA ANTI-BENTROK: Prioritas Tombol Manual daripada Jadwal
    onValue(ref(db, 'settings'), (snap) => {
        const s = snap.val();
        if(!s) return;

        const now = new Date();
        const mNow = now.getHours() * 60 + now.getMinutes();
        let isOff = false;
        let msg = "";

        // PRIORITAS 1: Tombol Manual di Dev Panel
        if(s.toko_locked === true) {
            isOff = true;
            msg = "SERVER SEDANG MAINTENANCE";
        } 
        // PRIORITAS 2: Jadwal (Hanya jalan kalau Toko TIDAK di-lock manual)
        else if(s.jadwal && s.jadwal.auto === true) {
            const [hB, mB] = s.jadwal.buka.split(':').map(Number);
            const [hT, mT] = s.jadwal.tutup.split(':').map(Number);
            const menitBuka = hB * 60 + mB;
            const menitTutup = hT * 60 + mT;

            if (mNow < menitBuka || mNow > menitTutup) {
                isOff = true;
                msg = `TOKO TUTUP. BUKA JAM ${s.jadwal.buka}`;
            }
        }

        if(isOff) {
            document.body.innerHTML = `
                <div style="height:100vh; background:#0a0d16; display:flex; align-items:center; justify-content:center; flex-direction:column; font-family:sans-serif; color:white; text-align:center;">
                    <div style="border:2px solid #ff4d4d; padding:40px; border-radius:20px; background:rgba(255,77,77,0.05); width:80%;">
                        <h1 style="color:#ff4d4d; font-size:2.5rem; margin-bottom:10px;">OFFLINE</h1>
                        <p style="opacity:0.7;">${msg}</p>
                    </div>
                </div>`;
            window.isLocked = true;
        } else {
            if(window.isLocked) location.reload();
        }
    });
</script>
