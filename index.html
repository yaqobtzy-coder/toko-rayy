// --- DEWA SECURITY & SATELLITE SYNC SYSTEM ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = { databaseURL: "https://rayy-all-web-default-rtdb.asia-southeast1.firebasedatabase.app/" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 1. GENERATE DEWA FINGERPRINT (HWID)
const getHWID = () => {
    const s = navigator.userAgent + navigator.language + screen.colorDepth + screen.width + screen.height;
    return btoa(s).substring(10, 25); // ID Unik Perangkat
};
const myID = getHWID();

// 2. ANTI-BAN & BLACKLIST CHECKER
function checkUserStatus(username) {
    onValue(ref(db, 'banned_users/' + username), (snap) => {
        if(snap.exists()) {
            alert("⚠️ AKUN ANDA TELAH DITERMINASI OLEH ARCHITECT! Akses ditutup.");
            document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:50px;'>403 - ACCESS TERMINATED</h1>";
            window.location.href = "about:blank";
        }
    });
}

// 3. AUTO-SCHEDULE SYSTEM (SINKRON DENGAN DEV PANEL)
function syncServerPower() {
    onValue(ref(db, 'settings/toko_locked'), (snap) => {
        const isLocked = snap.val();
        const payBtn = document.querySelector('.btn-bayar'); // Sesuaikan class tombol lu
        if(isLocked) {
            if(payBtn) {
                payBtn.disabled = true;
                payBtn.innerText = "SERVER OFFLINE / CLOSED";
                payBtn.style.background = "#444";
            }
        } else {
            if(payBtn) {
                payBtn.disabled = false;
                payBtn.innerText = "BAYAR SEKARANG";
                payBtn.style.background = "var(--primary)";
            }
        }
    });
}

// 4. TRANSACTION & LOGGING LOGIC
window.kirimPembayaran = async function() {
    const nama = document.getElementById('inputNama').value;
    const nominal = document.getElementById('inputNominal').value;

    if(!nama || !nominal) return alert("Isi data yang bener!");

    // Cek Ban dulu sebelum proses
    const banRef = ref(db, 'banned_users/' + nama);
    const checkBan = await get(banRef);
    if(checkBan.exists()) return alert("Gak usah maksa, akun lu udah di BAN!");

    const trxId = "TRX-" + Math.floor(Math.random() * 999999);
    
    // Kirim Data Transaksi ke Admin
    set(ref(db, 'transactions/' + trxId), {
        nama: nama,
        jumlah: nominal,
        status: "Pending",
        waktu: new Date().toLocaleString(),
        hwid: myID
    }).then(() => {
        // Log ke Dev Panel bahwa ada user bayar
        push(ref(db, 'system_logs'), {
            user: nama,
            action: "Melakukan Checkout Rp " + nominal,
            deviceId: myID,
            time: new Date().toLocaleTimeString()
        });
        
        alert("Pesanan dikirim! Tunggu admin konfirmasi.");
        showPaymentModal(trxId); // Panggil fungsi modal lu
    });
};

// INITIALIZE SYSTEM
document.addEventListener('DOMContentLoaded', () => {
    syncServerPower();
    console.log("RAYY ENGINE v10.0 ACTIVE | HWID: " + myID);
});
