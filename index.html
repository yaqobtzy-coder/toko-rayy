/* RAYY STORE DEWA ENGINE v12.0 
   SECURITY: AUTO-HWID VALIDATION (NO PASSWORD)
   FEATURES: INSTANT CHECKOUT, AUTO-BAN, LIVE SYNC
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = { databaseURL: "https://rayy-all-web-default-rtdb.asia-southeast1.firebasedatabase.app/" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// FINGERPRINT TANPA RIBET
const getDevice = () => {
    return "DEVICE-" + btoa(navigator.userAgent).substring(10, 25).toUpperCase();
};
const MY_DEVICE = getDevice();

// SYSTEM AUTO-RADAR
const syncSystem = () => {
    const payBtn = document.getElementById('btnBayar');
    onValue(ref(db, 'settings'), (snap) => {
        const data = snap.val();
        if(!data) return;
        const now = new Date();
        const curTime = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        const { open, close } = data.schedule;
        const isLocked = data.toko_locked;
        
        if(isLocked || (curTime < open || curTime > close)) {
            if(payBtn) {
                payBtn.disabled = true;
                payBtn.innerText = "STORE CLOSED / UNDER MAINTENANCE";
                payBtn.style.filter = "grayscale(1)";
            }
        } else {
            if(payBtn) {
                payBtn.disabled = false;
                payBtn.innerText = "BAYAR SEKARANG";
                payBtn.style.filter = "none";
            }
        }
    });
};

// INSTANT CHECKOUT (GAK PAKE PASSWORD)
window.prosesBayarRayy = async function() {
    const nama = document.getElementById('userName').value;
    const nominal = document.getElementById('itemPrice').value;

    if(!nama || !nominal) return Swal.fire("Woi!", "Isi nama sama nominalnya!", "warning");

    // CEK BAN OTOMATIS
    const check = await get(ref(db, `banned_users/${MY_DEVICE}`));
    if(check.exists()) return alert("DEVICE LU UDAH DI BAN!");

    const trxId = "RTX-" + Math.floor(Math.random() * 888888);

    set(ref(db, `transactions/${trxId}`), {
        nama: nama,
        jumlah: nominal,
        status: "Pending",
        waktu: new Date().toLocaleString(),
        deviceId: MY_DEVICE
    }).then(() => {
        push(ref(db, 'system_logs'), {
            user: nama,
            action: `Checkout Rp${nominal}`,
            deviceId: MY_DEVICE,
            time: new Date().toLocaleTimeString()
        });
        
        // Panggil Fungsi QRIS Lu di sini
        bukaModalQRIS(trxId, nominal);
    });
};

document.addEventListener('DOMContentLoaded', syncSystem);
