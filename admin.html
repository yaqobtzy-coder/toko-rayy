<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Monitoring System v3.0</title>
    
    <style>
        :root {
            --primary: #38bdf8;
            --bg: #0b1120;
            --card: #1e293b;
            --dark: #0f172a;
            --text: #f8fafc;
            --red: #ef4444;
            --green: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }

        .container { width: 100%; max-width: 550px; }

        /* --- LOGIN CARD --- */
        #loginSection { 
            background: var(--card); padding: 50px 35px; border-radius: 40px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.05); 
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); 
        }

        input { 
            width: 100%; padding: 20px; background: var(--dark); border: 2px solid transparent; 
            color: white; border-radius: 20px; font-size: 1rem; margin-bottom: 20px; text-align: center;
        }
        input:focus { border-color: var(--primary); }

        .btn-main { 
            width: 100%; padding: 20px; border: none; border-radius: 20px; 
            background: var(--primary); color: #0b1120; font-weight: 900; 
            text-transform: uppercase; cursor: pointer; transition: 0.3s;
        }

        /* --- MONITOR DASHBOARD --- */
        #monitorArea { display: none; width: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .item-card { 
            background: var(--card); padding: 25px; border-radius: 30px; 
            margin-bottom: 15px; border-left: 8px solid var(--primary); 
            position: relative; animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn-done { 
            width: 100%; margin-top: 15px; padding: 12px; border: none; 
            border-radius: 15px; background: var(--green); color: white; 
            font-weight: 800; cursor: pointer; 
        }
        .btn-done:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; }

        .overlay-full { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); z-index: 10000; display: flex; 
            align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loginSection">
            <h2 style="margin-bottom:10px; color:var(--primary); font-weight:900;">ADMIN PANEL</h2>
            <p style="opacity:0.4; font-size:0.8rem; margin-bottom:30px;">RAYY STORE MONITORING</p>
            <input type="text" id="adminUser" placeholder="Username">
            <input type="password" id="adminPass" placeholder="Password Master">
            <button class="btn-main" onclick="handleLogin()">MASUK DASHBOARD</button>
        </div>

        <div id="monitorArea">
            <div class="header">
                <h2>MONITORING</h2>
                <button onclick="location.reload()" style="background:transparent; color:var(--red); border:none; font-weight:900;">LOGOUT</button>
            </div>
            <div id="listTransaksi"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://rayy-all-web-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let activeAdmin = "";
        let isOwner = false;

        // --- SINKRONISASI TUTUP SERVER & BAN UNTUK ADMIN ---
        function startSecurityMonitor(username) {
            onValue(ref(db, 'settings'), (snap) => {
                const s = snap.val();
                if(!s) return;

                const check = () => {
                    // Owner (085794) Kebal Tutup Server
                    if(isOwner) return;

                    const now = new Date();
                    const cur = (now.getHours() * 60) + now.getMinutes();
                    const [hB, mB] = s.jadwal.buka.split(':').map(Number);
                    const [hT, mT] = s.jadwal.tutup.split(':').map(Number);
                    
                    let serverMati = false;
                    if(s.toko_locked === true || cur < (hB*60+mB) || cur > (hT*60+mT)) serverMati = true;

                    if(serverMati) {
                        document.body.innerHTML = `<div class="overlay-full"><div style="border:2px solid #ef4444; padding:50px; border-radius:40px;"><h1 style="color:#ef4444;">SERVER TUTUP</h1><p style="margin-top:20px;">Admin tidak dapat mengakses dashboard saat server offline.</p></div></div>`;
                    }
                };
                setInterval(check, 1000);
            });

            // Cek Real-time jika akun di-ban saat lagi buka web
            if(!isOwner) {
                onValue(ref(db, 'banned_users/' + username), (snap) => {
                    if(snap.exists()) {
                        document.body.innerHTML = `<div class="overlay-full"><div style="border:2px solid #ef4444; padding:50px; border-radius:40px;"><h1 style="color:#ef4444;">AKUN DIBLOKIR</h1><p style="margin-top:20px;">Anda telah diblokir dari sistem admin.</p><br><a href="https://wa.me/628131172093" style="color:var(--primary); font-weight:900; text-decoration:none;">HUBUNGI OWNER</a></div></div>`;
                    }
                });
            }
        }

        window.handleLogin = function() {
            const u = document.getElementById('adminUser').value.trim();
            const p = document.getElementById('adminPass').value.trim();

            if(p === "085794") {
                isOwner = true;
                initDashboard(u);
            } else {
                onValue(ref(db, 'sys_extra_admins/' + u), (snap) => {
                    const data = snap.val();
                    if(data && data.pass === p) {
                        initDashboard(u);
                        startSecurityMonitor(u);
                    } else { alert("Akses Ditolak!"); }
                }, { onlyOnce: true });
            }
        }

        function initDashboard(name) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('monitorArea').style.display = 'block';

            onValue(ref(db, 'transactions'), (snap) => {
                const list = document.getElementById('listTransaksi');
                list.innerHTML = "";
                const data = snap.val();
                if(data) {
                    Object.keys(data).reverse().forEach(id => {
                        const t = data[id];
                        const done = t.status === "Success";
                        list.innerHTML += `
                            <div class="item-card" style="border-left-color: ${done ? '#22c55e' : '#38bdf8'}">
                                <span style="position:absolute; top:20px; right:25px; font-size:0.7rem; font-weight:900; color:${done ? '#22c55e' : '#f59e0b'}">${t.status}</span>
                                <h3 style="margin-bottom:5px;">${t.nama}</h3>
                                <p style="color:var(--primary); font-weight:900; font-size:1.1rem;">Rp ${Number(t.jumlah).toLocaleString()}</p>
                                <p style="font-size:0.7rem; opacity:0.4; margin-top:10px;">${t.waktu}</p>
                                <button class="btn-done" ${done ? 'disabled' : ''} onclick="confirmTr('${id}')">${done ? 'âœ“ SUKSES' : 'KONFIRMASI SELESAI'}</button>
                            </div>`;
                    });
                }
            });
        }

        window.confirmTr = function(id) {
            update(ref(db, 'transactions/' + id), { status: "Success" });
        }
    </script>
</body>
</html>
